# cargo-dist release workflow
# This file is partially generated by cargo-dist
# To regenerate: cargo dist init
#
# Handles binary distribution when tags are pushed

name: Release
on:
  pull_request:
  push:
    tags:
      - '**[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write
  id-token: write
  attestations: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Run cargo-dist in 'plan' mode to determine what to build
  plan:
    runs-on: ubuntu-latest
    outputs:
      val: ${{ steps.plan.outputs.manifest }}
      tag: ${{ !github.event.pull_request && github.ref_name || '' }}
      tag-flag: ${{ !github.event.pull_request && format('--tag={0}', github.ref_name) || '' }}
      publishing: ${{ !github.event.pull_request }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/install-tools
        with:
          tools: cargo-dist
      - name: Plan release
        id: plan
        run: |
          cargo dist plan ${{ !github.event.pull_request && format('--tag={0}', github.ref_name) || '' }} --output-format=json > plan.json
          echo "manifest=$(cat plan.json | jq -c)" >> "$GITHUB_OUTPUT"

  # Build artifacts for each target
  build-local-artifacts:
    name: Build (${{ matrix.target }})
    needs: [plan]
    if: ${{ fromJson(needs.plan.outputs.val).ci.github.artifacts_matrix.include != null && (needs.plan.outputs.publishing == 'true' || fromJson(needs.plan.outputs.val).ci.github.pr_run_mode == 'upload') }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.val).ci.github.artifacts_matrix }}
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/install-tools
        with:
          tools: cargo-dist
      - name: Build artifacts
        run: |
          cargo dist build ${{ needs.plan.outputs.tag-flag }} --output-format=json "--artifacts=${{ matrix.dist-args }}" > dist-manifest.json
          echo "artifacts manifest:"
          cat dist-manifest.json
      - name: Attest provenance
        if: needs.plan.outputs.publishing == 'true'
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # ratchet:actions/attest-build-provenance@v2
        with:
          subject-path: target/distrib/*
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: artifacts-build-local-${{ join(matrix.targets, '_') }}
          path: |
            target/distrib/

  # Create the GitHub release and upload artifacts
  publish-release:
    name: Publish Release
    needs: [plan, build-local-artifacts]
    if: needs.plan.outputs.publishing == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          submodules: recursive
      - uses: ./.github/actions/install-tools
        with:
          tools: cargo-dist
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # ratchet:actions/download-artifact@v4
        with:
          pattern: artifacts-*
          path: target/distrib/
          merge-multiple: true
      - name: Create release
        run: cargo dist host --steps=upload --steps=release ${{ needs.plan.outputs.tag-flag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
