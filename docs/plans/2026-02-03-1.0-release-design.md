# tiny-update-check 1.0 Release Plan

## Overview

Prepare tiny-update-check for a stable 1.0 release by fixing brittleness issues, adding pre-release filtering, input validation, and optional async support.

## Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| JSON parsing | Improved string parsing | Keep zero-dependency approach; serde_json deferred (issue #11) |
| Pre-release versions | Filter by default | Most CLI users want stable versions only |
| Input validation | Validate in `check()` | Keep `new()` infallible, fail early with clear errors |
| Async support | Feature flag + reqwest | Users who want async already accept heavier deps |

## Scope

### 1. Robust JSON Parsing

**Problem:** Current string search for `"newest_version":"` is fragile - doesn't handle whitespace variations, could match wrong location.

**Solution:** Improved parser that:
- Scopes search to `"crate"` object first
- Handles whitespace: `"key": "value"` and `"key":"value"`
- Well-tested against real API response fixtures

**Files:**
- `src/lib.rs`: Replace `fetch_latest_version()` parsing logic
- `tests/parsing.rs`: New test file with fixtures

**Test fixtures needed:**
- Real crates.io response snapshot (e.g., `serde`)
- Compact JSON (no whitespace)
- Pretty-printed JSON
- Whitespace variations around colons

### 2. Pre-release Version Filtering

**Problem:** Reports `2.0.0-beta.1` as an update when user is on `1.0.0`, which most users don't want.

**Solution:**
- Add `include_prerelease: bool` field to `UpdateChecker` (default: `false`)
- Add `.include_prerelease(bool)` builder method
- Filter in `check()`: skip if `latest_ver.pre.is_empty() == false && !self.include_prerelease`

**API:**
```rust
let checker = UpdateChecker::new("my-crate", "1.0.0")
    .include_prerelease(true);  // opt-in to pre-release notifications
```

**Files:**
- `src/lib.rs`: Add field, builder method, filtering logic
- `tests/integration.rs`: Add prerelease filtering tests

### 3. Crate Name Validation

**Problem:** Invalid crate names fail at HTTP time with generic errors.

**Solution:**
- Add `InvalidCrateName(String)` variant to `Error` enum
- Validate in `check()` before HTTP request
- Validation rules: non-empty, ASCII alphanumeric + `-` + `_`, max 64 chars, starts with letter

**Files:**
- `src/lib.rs`: Add error variant, validation function, call from `check()`

### 4. Async Feature Flag

**Problem:** No async support for async CLI applications.

**Solution:**
- Add `async` feature flag
- Add optional `reqwest` dependency
- Create `src/async.rs` with async versions of check functions
- Re-export from `lib.rs` behind feature gate

**Cargo.toml:**
```toml
[features]
default = ["native-tls"]
native-tls = ["ureq/native-tls"]
rustls = ["ureq/rustls"]
async = ["reqwest"]

[dependencies]
reqwest = { version = "0.12", optional = true, default-features = false, features = ["rustls-tls"] }
```

**API:**
```rust
// With `async` feature enabled
use tiny_update_check::r#async::UpdateChecker;

let checker = UpdateChecker::new("my-crate", "1.0.0");
if let Ok(Some(update)) = checker.check().await {
    println!("Update available: {}", update.latest);
}
```

**Files:**
- `Cargo.toml`: Add feature and optional dep
- `src/async.rs`: New file with async implementation
- `src/lib.rs`: Conditional re-export

## Implementation Order (TDD Approach)

Each feature follows test-driven development: write failing tests first, then implement.

### 1. JSON Parsing Fix

**Tests first:**
```rust
#[test]
fn parses_real_crates_io_response() { ... }

#[test]
fn parses_compact_json() { ... }

#[test]
fn parses_pretty_json() { ... }

#[test]
fn parses_whitespace_around_colon() { ... }

#[test]
fn fails_on_missing_crate_field() { ... }

#[test]
fn fails_on_missing_newest_version() { ... }
```

**Then implement:** Extract parsing to testable function, fix logic.

### 2. Crate Name Validation

**Tests first:**
```rust
#[test]
fn rejects_empty_crate_name() { ... }

#[test]
fn rejects_crate_name_with_spaces() { ... }

#[test]
fn rejects_crate_name_starting_with_number() { ... }

#[test]
fn accepts_valid_crate_names() { ... }
```

**Then implement:** Add validation function, wire into `check()`.

### 3. Pre-release Filtering

**Tests first:**
```rust
#[test]
fn filters_prerelease_by_default() { ... }

#[test]
fn includes_prerelease_when_opted_in() { ... }

#[test]
fn stable_to_stable_update_detected() { ... }
```

**Then implement:** Add field, builder method, filtering logic.

### 4. Async Feature

**Tests first:**
```rust
#[cfg(feature = "async")]
#[tokio::test]
async fn async_check_works() { ... }

#[cfg(feature = "async")]
#[tokio::test]
async fn async_respects_timeout() { ... }
```

**Then implement:** Create async module, wire up reqwest.

## Testing Strategy (TDD)

**Core principle:** Write tests before implementation. Each feature starts with failing tests that define expected behavior.

### TDD Workflow

1. **Red:** Write a failing test that defines expected behavior
2. **Green:** Write minimal code to make the test pass
3. **Refactor:** Clean up while keeping tests green

### Test Organization

```
tests/
├── fixtures/
│   ├── serde_response.json    # Real API snapshot
│   ├── compact.json           # Minified JSON
│   └── pretty.json            # Formatted JSON
├── parsing.rs                 # JSON parsing unit tests
├── validation.rs              # Crate name validation tests
└── integration.rs             # End-to-end tests (existing)
```

### Unit Tests (Write First)
- JSON parsing against fixtures (various formats)
- Crate name validation (valid/invalid cases)
- Pre-release version comparison logic
- Error message formatting

### Integration Tests
- Real network call to crates.io (existing)
- Pre-release filtering behavior
- Validation error messages

### Test Fixtures
Fetch real response before writing parsing tests:
```bash
curl -s https://crates.io/api/v1/crates/serde > tests/fixtures/serde_response.json
```

## Public API Surface (1.0)

```rust
// Structs
pub struct UpdateChecker { ... }
pub struct UpdateInfo {
    pub current: String,
    pub latest: String,
}

// Enum
pub enum Error {
    HttpError(String),
    ParseError(String),
    VersionError(String),
    CacheError(String),
    InvalidCrateName(String),  // NEW
}

// UpdateChecker methods
impl UpdateChecker {
    pub fn new(crate_name: impl Into<String>, current_version: impl Into<String>) -> Self;
    pub fn cache_duration(self, duration: Duration) -> Self;
    pub fn timeout(self, timeout: Duration) -> Self;
    pub fn cache_dir(self, dir: Option<PathBuf>) -> Self;
    pub fn include_prerelease(self, include: bool) -> Self;  // NEW
    pub fn check(&self) -> Result<Option<UpdateInfo>, Error>;
}

// Convenience function
pub fn check(crate_name: impl Into<String>, current_version: impl Into<String>) -> Result<Option<UpdateInfo>, Error>;

// Async module (behind feature flag)
#[cfg(feature = "async")]
pub mod r#async { ... }
```

## Out of Scope

- GitHub releases support (post-1.0)
- Custom registry trait (post-1.0)
- Test mocking utilities (post-1.0)
- serde_json migration (issue #11)

## Related Issues

- #11 - Consider using serde_json for more robust JSON parsing
